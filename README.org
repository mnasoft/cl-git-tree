#+TITLE: cl-git-tree
#+AUTHOR: Mykola Matvyeyev
#+LANGUAGE: ru

* Описание

cl-git-tree — консольный инструмент для управления деревом git-репозиториев,
написанный на Common Lisp. Позволяет выполнять git-операции (pull, push, commit, add и др.)
над всеми репозиториями в каталоге одной командой, а также создавать и удалять
репозитории на GitHub, GitLab и в локальных хранилищах.

** Основные возможности

- *Массовые операции*: выполнение git-команд (pull, push, add, commit) сразу для всех репозиториев в дереве каталогов.
- *Управление репозиториями*: создание (=git-tree create=) и удаление (=git-tree delete=) репозиториев на провайдерах (GitHub, GitLab, локально).
- *Локации*: регистрация шаблонов локаций (URL, пути) для упрощения управления репозиториями разных провайдеров.
- *Офлайн-транспорт*: экспорт репозиториев в tar.xz архивы и импорт на другие машины для синхронизации без интернета.
- *Аудит*: проверка состояния репозиториев (грязные, неслежённые файлы, незакоммиченные изменения).

* Возможности

** Управление локациями
- Регистрация и хранение локаций в глобальной таблице =*locations*=.
- Поддержка трёх типов провайдеров:
  - =:local= — локальные пути для git‑репозиториев.
  - =:github= — публичные репозитории на GitHub (шаблон =git@github.com:username/=).
  - =:gitlab= — публичные репозитории на GitLab (шаблон =git@gitlab.com:username/=).
- Нормализация и валидация URL при добавлении локаций.
- Сохранение/загрузка конфигурации из файла =~/.git-tree/locations.lisp=.

** Синхронизация репозиториев
- Локальное клонирование репозиториев из известных локаций (=clone= / =unclone=).
- Синхронизация с удалёнными хостами (=clone-remote= / =unclone-remote=).
- Создание bare‑репозиториев на локальных хостах или удалённых серверах (=remote create= / =remote-create=).
- Офлайн-транспорт репозиториев: упаковка bare-клонов в =tar.xz= (=transport export=) и импорт на другой машине (=transport import=).

** Git-операции
- Управление файлами в репозиториях: =add=, =commit=.
- Синхронизация ветвей: =pull=, =push=.
- Управление remotes: =remote add=, =remote remove=, =remote readd=, =remote create=, =remote delete=.
- Просмотр статуса репозиториев: =audit status=.
- Аудит состояния: =audit dirty/staged/untracked=.

** Конфигурация и вспомогательные команды
- Управление локациями: =locations list/show/add/edit/remove/save=.
- Управление шаблонами файлов для отслеживания: =patterns=.
- Показать информацию о системе: =info=.
- Просмотр команд и их алиасов: =aliases=.
- Универсальное применение операций ко всем репозиториям: =all= (pull → add → commit → push).

* Архитектура

** Основные компоненты

| Модуль | Описание |
|--------|---------|
| =cl-git-tree= | Основная система, координирующая подсистемы. |
| =cl-git-tree/loc= | Управление локациями: классы =<location>=, =<provider>=, =<local>=, =<github>=, =<gitlab>= и API (=add-location=, =find-location=, =repo-url= и т.д.). Глобальный реестр =*locations*=. |
| =cl-git-tree/dispatch= | Диспетчер CLI-команд, реестр =*commands*= и функция =dispatch-command=. |
| =cl-git-tree/cli= | Точка входа (функция =main=), вывод справки. |
| =cl-git-tree/fs= | Утилиты для работы с файловой системой: поиск git‑репозиториев (=find-git-repos=), проверка репозиториев (=git-repo-p=). |
| =cl-git-tree/git-utils= | Обёртки для git-команд: =git-run=, =current-branch=, =repo-remotes=. |
| =cl-git-tree/shell-utils= | Утилиты для вызова shell-команд и работы с SSH. |
| =cl-git-tree/commands/*= | Набор из 20+ CLI-команд, регистрируемых автоматически при загрузке. |

** Данные и конфигурация

- Глобальная таблица *locations* (hash-table) — хранит все зарегистрированные локации.
- Файл конфигурации: =~/.git-tree/locations.lisp= — содержит формы =(add-location ...)= для загрузки при старте.
- Файл шаблонов: =~/.git-tree/file-patterns.lisp= — регулярные выражения для фильтрации файлов при синхронизации.

** Паттерны проектирования

- *Полиморфизм через провайдеры*: методы =remote-create=, =repo-add= и т.д. диспетчеризуются по типу провайдера (=<local>=, =<github>=, =<gitlab>=).
- *Реестры команд*: CLI-команды регистрируются в =*commands*= при загрузке модулей.
- *Глобальное состояние*: =*locations*= и =*commands*= позволяют модулям регистрировать себя и друг друга без явной передачи параметров.

* Требования

** Зависимости

Для работы cl-git-tree необходимо установить:

1. *Git* (версия 2.0 и выше)
   - Используется для всех операций с репозиториями (clone, pull, push, commit и т.д.).
   - Linux: =apt install git= (Debian/Ubuntu) или =pacman -S git= (MSYS2)
   - macOS: =brew install git= или входит в Xcode Command Line Tools

2. *Common Lisp* (SBCL — Steel Bank Common Lisp)
   - Требуется для выполнения скриптов и сборки бинарника.
   - Linux: =apt install sbcl= (Debian/Ubuntu) или =pacman -S sbcl= (MSYS2)
   - macOS: =brew install sbcl=

3. *Quicklisp* (опционально для работы из исходников)
   - Менеджер пакетов Common Lisp.
   - Установка: https://www.quicklisp.org/beta/
   - Проект должен быть расположен в =~/quicklisp/local-projects/clisp/cl-git-tree/= для автоматической загрузки.

** Поддерживаемые системы

- *Linux* (всех популярных дистрибьютивов: Ubuntu, Debian, Fedora, Arch и т.д.)
  - Полная поддержка всех команд и функций.
  
- *Windows с MSYS2*
  - Интегрированное окружение с Unix-подобной средой bash.
  - Требуется установить пакеты: =pacman -S sbcl git=
  - Поддержка путей с прямыми слэшами (=/=), избегайте обратных слэшей (=\=).
  - Автоматическое разворачивание тильды (=~=) в переменную окружения =$HOME=.

- *macOS*
  - Поддержка всех команд через Terminal.app или аналогичные эмуляторы.

* Установка

** Сборка standalone бинарника

Для удобного распространения можно собрать самостоятельный исполняемый файл (бинарник), не требующий установленного SBCL/Quicklisp на целевой машине.

1. Соберите бинарник:
  #+begin_src bash
  ./build-bin.sh
  #+end_src
  В результате появится файл =bin/git-tree=.

2. Используйте бинарник аналогично скрипту:
  #+begin_src bash
  ./bin/git-tree [команда] [аргументы]
  #+end_src

** Отличие бинарника и скрипта

- =cli-script.lisp= — старый способ запуска через SBCL (требует установленного SBCL и Quicklisp).
- =bin/git-tree= — самостоятельный бинарник, не требует внешних зависимостей (всё внутри).
- Оба варианта поддерживают одинаковый CLI-интерфейс и команды.

** Пример запуска

#+begin_src bash
# Справка по командам
./bin/git-tree --help
# Клонирование
./bin/git-tree clone gh cl-git-tree
#+end_src

** Через Quicklisp
#+begin_src lisp
(ql:quickload "cl-git-tree")
#+end_src

** Из локального исходника
#+begin_src bash
# Убедитесь, что проект находится в ~/quicklisp/local-projects/clisp/cl-git-tree/
cd ~/quicklisp/local-projects/clisp/cl-git-tree
sbcl --eval "(progn (require 'asdf) (asdf:load-system :cl-git-tree))"
#+end_src

* Использование

** Примеры в Lisp API

Регистрация локаций и построение URL:
#+begin_src lisp
(cl-git-tree/loc:add-location "gh"
  :description "GitHub — шаблон для публичных проектов"
  :url-git "git@github.com:username/"
  :provider :github)

(cl-git-tree/loc:add-location "lc"
  :description "Local mirror"
  :url-git "/home/user/.git-tree/git/lc/"
  :provider :local)

;; Построение URL репозитория
(cl-git-tree/loc:repo-url "gh" "cl-git-tree")
;; => "git@github.com:username/cl-git-tree.git"

;; Получение объекта локации
(cl-git-tree/loc:find-location "lc")
;; => #<CL-GIT-TREE/LOC:<LOCAL> id="lc" ...>

;; Список всех локаций
(cl-git-tree/loc:all-location-keys)
;; => ("gh" "lc")
#+end_src

* Документация

Для генерации HTML-документации и графов зависимостей:
#+begin_src lisp
(ql:quickload :cl-git-tree/docs)
(cl-git-tree/docs:make-all)
#+end_src
Требуются системы =mnas-package= и =codex=; для публикации по rsync необходим установленный =rsync=.

** Примеры в CLI

Использование из командной строки через SBCL:
#+begin_src bash
# Показать справку
sbcl --eval "(progn (require 'asdf) (asdf:load-system :cl-git-tree) (cl-git-tree/cli:main '(\"prog\" \"--help\")))" --quit

# Показать список локаций
sbcl --eval "(progn (require 'asdf) (asdf:load-system :cl-git-tree) (cl-git-tree/cli:main '(\"prog\" \"locations\" \"list\")))" --quit

# Добавить локацию
sbcl --eval "(progn (require 'asdf) (asdf:load-system :cl-git-tree) (cl-git-tree/cli:main '(\"prog\" \"locations\" \"add\" \"myrepo\" \":url-git\" \"/tmp/repos\")))" --quit

# Клонировать репозиторий из локации
sbcl --eval "(progn (require 'asdf) (asdf:load-system :cl-git-tree) (cl-git-tree/cli:main '(\"prog\" \"clone\" \"gh\" \"cl-git-tree\")))" --quit
#+end_src

*** Паттерны файлов

Управление списками отслеживаемых и исключаемых файлов:

#+begin_src bash
git tree patterns                         # краткая справка
git tree patterns list                    # показать все паттерны
git tree patterns list tracked            # только включаемые
git tree patterns list excluded           # только исключаемые

git tree patterns add tracked '*.rs'      # добавить паттерн включения
git tree patterns add excluded '*.o'      # добавить паттерн исключения

git tree patterns remove tracked '*.tcl*' # удалить паттерн включения
git tree patterns remove excluded '*.log' # удалить паттерн исключения

git tree patterns reset                   # сбросить на значения по умолчанию
#+end_src

** Офлайн-транспорт (архивы tar.xz)

Управление архивами репозиториев для портативной синхронизации между машинами без прямого доступа к интернету или при ограниченной полосе пропускания.

*** Команды

#+begin_src bash
git tree transport export [--days N] [--verbose] [--help]
git tree transport import [--keep-remote-dir] [--delete-archive] [--verbose] [--help]
git tree transport clean [--help]
#+end_src

*** Export — создание архивов

Архивирует чистые репозитории (без незакоммиченных изменений) в tar.xz файлы для последующего переноса на другие машины.

#+begin_src bash
git tree transport export                # краткий вывод (архивирует последние 7 дней)
git tree transport export --days 1       # архивировать только очень свежие репозитории
git tree transport export --days 3000    # архивировать все репозитории
git tree transport export --verbose      # подробный вывод с причинами пропусков
git tree transport export --help         # справка по export
#+end_src

Опции:
- =--days N= — архивировать репозитории с коммитами не старее N дней (по умолчанию 7).
- =--verbose= — показывать причины пропусков (старые коммиты, незакоммиченные изменения и т.д.).

Результат: архивы создаются в `:url-xz` каждого провайдера, который его имеет.

*** Import — распаковка архивов

Импортирует архивы из `:url-xz` в bare-хранилища (`:url-git`), выполняя `fetch` и `pull` всех веток.

#+begin_src bash
git tree transport import                    # распаковать и импортировать архивы
git tree transport import --verbose          # подробный вывод по каждому репозиторию
git tree transport import --keep-remote-dir  # сохранить временный каталог remote
git tree transport import --delete-archive   # удалить архив после успешного импорта
git tree transport import --help             # справка по import
#+end_src

Опции:
- =--verbose= — вывести информацию о каждом импортируемом репозитории и его ветках.
- =--keep-remote-dir= — по умолчанию временный каталог remote удаляется; при этой опции он сохраняется.
- =--delete-archive= — удалить архив после успешного импорта (освобождает место).

Результат: архивы распаковываются в `:url-git`, для каждой ветки выполняется `pull`.

*** Clean — очистка архивов

Удаляет все *.tar.xz архивы из каталогов `:url-xz` всех провайдеров.

#+begin_src bash
git tree transport clean       # удалить все архивы из :url-xz
git tree transport clean --help # справка по clean
#+end_src

Полезна для очистки переносных носителей или дисков после завершения импорта на целевой машине.

*** Логика работы

*Export:*
- Обходит все найденные git-репозитории в текущей директории.
- Для каждого репозитория проверяет его состояние:
  - Репозиторий должен быть чистым (без незакоммиченных изменений).
  - Последний коммит должен быть не старше указанного количества дней (по умолчанию 7).
- При успехе создаёт bare-клон (=git clone --bare=) и упаковывает в tar.xz архив в `:url-xz` провайдера.
- При флаге =--verbose= показывает причины пропусков репозиториев.

*Import:*
- Обходит все локации с заданным `:url-xz` и ищет архивы *.tar.xz.
- Для каждого архива:
  1. Распаковывает в временный каталог.
  2. Подключает временный remote (например, =lc-import=) к рабочему репозиторию.
  3. Выполняет =git fetch= из временного remote для получения всех веток.
  4. Выполняет =git pull= для каждой найденной ветки (dev, master и т.д.).
  5. Отключает временный remote и удаляет временный каталог (кроме =--keep-remote-dir=).
  6. При флаге =--delete-archive= удаляет архив после успешного импорта.
- При флаге =--verbose= выводит информацию по каждому репозиторию и его веткам.

*Clean:*
- Обходит все провайдеры и ищет файлы *.tar.xz в их `:url-xz` каталогах.
- Удаляет найденные архивы и выводит статистику по удалённым файлам.

** Конфигурация

Тильда в путях конфигурации разворачивается автоматически (~/ → $HOME) при загрузке.

Автоматическая загрузка локаций при старте:
- Создайте файл =~/.git-tree/locations.lisp= содержащий формы =(add-location ...)=:
#+begin_src lisp
(in-package :cl-git-tree/loc)

(add-location "gh"
  :description "GitHub"
  :url-git "git@github.com:mnasoft/"
  :provider :github)

(add-location "lc"
  :description "Local mirror"
  :url-git "~/.git-tree/git/lc/"
  :url-xz "~/.git-tree/xz/lc/"
  :provider :local)
#+end_src

- Функция =cl-git-tree:load-config= автоматически загружает этот файл при старте системы.

* Справочник команд

Полный список доступных CLI-команд:

| Команда | Описание |
|---------|---------|
| =add= | Добавить файлы в индекс (git add) |
| =clone= | Клонировать все локальные репозитории из известных локаций |
| =commit= | Сделать git commit во всех репозиториях |
| =pull= | Выполнить git pull во всех репозиториях |
| =push= | Выполнить git push во всех репозиториях |
| =all= | Выполнить pull → add → commit → push по порядку |
| =remote= | Управление remote (add/remove/readd/create/delete) |
| =locations= | Управление локациями (list/show/add/edit/remove/save) |
| =patterns= | Управление паттернами файлов (list/add/remove/reset) |
| =aliases= | Показать git-алиасы и доступные команды |
| =info= | Показать информацию о системе и зарегистрированных локациях |
| =transport= | Архивация репозиториев в tar.xz / импорт / очистка |
| =audit= | Проверка состояния репозиториев (status/dirty/staged/untracked) |
| =remake-xz= | Пересоздание архивов (внутренняя команда) |
| =help= | Показать справку |
| =version= | Показать версию |

** Подкоманды remote

| Подкоманда | Описание |
|------------|---------|
| =list= | Показать все доступные локации |
| =add LOC-KEY= | Добавить remote во все репозитории |
| =remove LOC-KEY= | Удалить remote из всех репозиториев |
| =readd LOC-KEY= | Заново добавить remote во все репозитории |
| =create LOC-KEY [--private]= | Создать репозиторий на провайдере |
| =delete LOC-KEY= | Удалить репозиторий на провайдере |

* Тестирование

Запуск набора тестов:
#+begin_src bash
sbcl --eval "(progn (require 'asdf) (asdf:load-system :cl-git-tree-tests) (uiop:symbol-call :cl-git-tree/tests :run-tests))" --quit
#+end_src

Ожидаемый результат: =Did 122 checks. Pass: 122 (100%). Skip: 0. Fail: 0.=

** Покрытие тестами

Система включает тесты для всех основных компонентов:

| Модуль | Файл теста | Описание |
|--------|-----------|---------|
| Locations | =test-location.lisp= | API локаций: добавление, нормализация URL, определение провайдеров |
| Dispatcher | =test-dispatch.lisp= | Регистрация команд, диспетчеризация, обработка ошибок |
| Commands | =test-all-commands.lisp= | Проверка регистрации всех CLI-команд и подкоманд |
| Shell Utils | =test-shell-utils.lisp= | Парсинг SSH URL, разбор аргументов командной строки |
| FS | =test-fs.lisp= | Поиск git-репозиториев, проверка структуры |
| Git Utils | =test-git-utils.lisp= | Обёртки для git-команд |
| Config | =test-global.lisp=, =test-patterns.lisp= | Загрузка конфигурации, управление шаблонами файлов |
| Commands | =test-commands.lisp= | CLI-команды |
| Workspace | =workspace/*.lisp= | Создание и управление workspace-объектами |

* Разработка

** Структура проекта
#+begin_src
cl-git-tree/
├── src/
│   ├── cli.lisp                          # CLI точка входа (main)
│   ├── config.lisp                       # Загрузка конфигурации при старте
│   ├── package.lisp                      # Основной пакет
│   ├── commands/                         # 23 CLI-команды
│   │   ├── add.lisp                      # git add (файловые операции)
│   │   ├── aliases.lisp                  # Показать команды и алиасы
│   │   ├── all.lisp                      # pull → add → commit → push
│   │   ├── audit.lisp                    # Проверка состояния репозиториев
│   │   ├── commit.lisp                   # git commit (файловые операции)
│   │   ├── info.lisp                     # Информация о системе
│   │   ├── locations.lisp                # Управление локациями
│   │   ├── patterns.lisp                 # Управление паттернами файлов
│   │   ├── pull.lisp                     # git pull (синхронизация)
│   │   ├── push.lisp                     # git push (синхронизация)
│   │   ├── remake-xz.lisp                # Пересоздание архивов
│   │   ├── remote.lisp                   # Справка по управлению remote
│   │   ├── remote-add.lisp               # Добавить remote
│   │   ├── remote-create.lisp            # Создать bare-репозиторий
│   │   ├── remote-delete.lisp            # Удалить remote на провайдере
│   │   ├── remote-readd.lisp             # Заново добавить remote
│   │   ├── remote-remove.lisp            # Удалить remote
│   │   ├── transport.lisp                # Справка по архивам
│   │   ├── transport-clean.lisp          # Удалить *.tar.xz
│   │   ├── transport-export.lisp         # Создать архивы
│   │   └── transport-import.lisp         # Импортировать архивы
│   ├── dispatch/
│   │   ├── dispatcher.lisp               # Реестр и диспетчер команд
│   │   └── package.lisp
│   ├── loc/
│   │   ├── defclass.lisp                 # Классы <location>, <workspace>
│   │   ├── defgeneric.lisp               # Сигнатуры методов
│   │   ├── provider.lisp                 # Классы провайдеров
│   │   ├── location.lisp                 # API для работы с локациями
│   │   ├── workspace.lisp                # API для workspace
│   │   ├── methods/                      # Методы для провайдеров (20+ методов)
│   │   │   ├── clone.lisp, repo-add.lisp, repo-commit.lisp
│   │   │   ├── remote-create/delete/add/readd/remove.lisp
│   │   │   ├── repo-push.lisp, repo-pull.lisp
│   │   │   └── ...
│   │   └── package.lisp
│   ├── fs/
│   │   ├── fs.lisp                       # Утилиты файловой системы
│   │   └── package.lisp
│   ├── git-utils/
│   │   ├── git-utils.lisp                # Обёртки для git-команд
│   │   └── package.lisp
│   ├── shell-utils/
│   │   ├── core.lisp                     # Выполнение shell-команд
│   │   ├── ssh-utils.lisp                # Парсинг SSH URL
│   │   └── package.lisp
│   ├── config/                           # Управление конфигурациями
│   │   ├── defaults.lisp                 # Значения по умолчанию
│   │   ├── file-patterns.lisp            # Управление паттернами файлов
│   │   └── package.lisp
│   ├── global/
│   │   ├── git-global.lisp               # Глобальные переменные git
│   │   └── package.lisp
│   └── package.lisp                      # Основной пакет
├── tests/                                # Набор тестов (15+ тестовых модулей)
│   ├── test-location.lisp                # Тесты для локаций
│   ├── test-global.lisp                  # Тесты конфигурации
│   ├── test-dispatch.lisp                # Тесты диспетчера команд
│   ├── test-commands.lisp                # Тесты CLI-команд
│   ├── test-all-commands.lisp            # Проверка регистрации команд
│   ├── test-shell-utils.lisp             # Тесты парсинга
│   ├── test-fs.lisp                      # Тесты файловой системы
│   ├── test-git-utils.lisp               # Тесты git-обёрток
│   ├── test-patterns.lisp                # Тесты паттернов
│   ├── test-transport.lisp               # Тесты архивов
│   ├── workspace/                        # Тесты для workspace
│   ├── run.lisp                          # Запуск всех тестов
│   └── package.lisp
├── cl-git-tree.asd                       # Определение системы ASDF
├── cl-git-tree-tests.asd                 # Система тестов ASDF
├── cli-script.lisp                       # Скрипт для запуска из командной строки
├── README.org                            # Этот файл
├── ToDo.org                              # План развития проекта
└── install-git-tree.sh                   # Скрипт установки
#+end_src

** Добавление новой команды

1. Создайте файл в =src/commands/your-command.lisp=:
#+begin_src lisp
(defpackage :cl-git-tree/commands/your-command
  (:use :cl :cl-git-tree/loc :cl-git-tree/dispatch)
  (:export cmd-your-command))

(in-package :cl-git-tree/commands/your-command)

(defun cmd-your-command (&rest args)
  "Описание вашей команды."
  (format t "Выполнение команды your-command с аргументами: ~A~%" args))

;; Регистрируем команду в диспетчере
(eval-when (:load-toplevel :execute)
  (register-command "your-command" #'cmd-your-command "Описание команды"))
#+end_src

2. Добавьте загрузку модуля в =cl-git-tree.asd=:
#+begin_src lisp
(:file "commands/your-command")
#+end_src

3. Команда будет автоматически доступна при загрузке системы.

** Запуск тестов с покрытием

Для проверки кода перед коммитом:
#+begin_src bash
cd /home/mna/quicklisp/local-projects/clisp/cl-git-tree
sbcl --eval "(progn (require 'asdf) (asdf:load-system :cl-git-tree-tests) (uiop:symbol-call :cl-git-tree/tests :run-tests))" --quit
#+end_src

* Лицензия
Проект распространяется под лицензией GNU GPL v3 или более поздней версии.
