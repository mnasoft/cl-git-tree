#!/bin/bash
# Wrapper for MSYS2: run SBCL with an embedded temporary script
# This avoids relying on a separate cli-script.lisp file.

SCRIPT_FILE="${BASH_SOURCE[0]}"
if [ -L "$SCRIPT_FILE" ]; then
  # resolve symlink to absolute path when possible
  if command -v readlink >/dev/null 2>&1; then
    SCRIPT_FILE=$(readlink -f "$SCRIPT_FILE" 2>/dev/null || printf '%s' "$SCRIPT_FILE")
  fi
fi
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_FILE")" && pwd)"

SBCL=$(command -v sbcl 2>/dev/null)
if [ -z "$SBCL" ]; then
  echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: SBCL Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð² PATH"
  echo "ðŸ’¡ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ: pacman -S mingw-w64-ucrt64-sbcl"
  exit 1
fi

# Create a temporary Lisp script that loads quicklisp and starts the CLI.
TMP_SCRIPT=$(mktemp /tmp/git-tree-msys2.XXXXXX.lisp)
cat > "$TMP_SCRIPT" <<'LISP'
(load (merge-pathnames "quicklisp/setup.lisp" (user-homedir-pathname)))

;; Silent load
(let ((*standard-output* (make-broadcast-stream)))
  (ql:quickload :cl-git-tree :silent t))

(cl-git-tree/cli:main sb-ext:*posix-argv*)
LISP

"$SBCL" --script "$TMP_SCRIPT" "$@"
RC=$?
rm -f "$TMP_SCRIPT"
exit $RC
